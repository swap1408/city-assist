version: "3.9"

networks:
  appnet:
    driver: bridge

services:
  # Use this when you ALSO run the backend in Docker
  frontend:
    build: .
    image: citizen-flow:latest
    ports:
      - "8081:80"
    environment:
      # Frontend will call same-origin /api; NGINX proxies to this URL
      BACKEND_URL: ${BACKEND_URL:-http://backend:8080}
      # Leave empty to use same-origin + proxy
      VITE_API_URL: ""
      # Python FastAPI URL (absolute)
      CITYASSIST_API_URL: ${CITYASSIST_API_URL:-http://python:8000}
    depends_on:
      - backend
      - python
    networks: [appnet]
    profiles: ["with-backend"]

  python:
    build:
      context: ../cityassist-python
    image: cityassist-python:latest
    environment:
      ALLOW_ORIGINS: ${ALLOW_ORIGINS:-http://localhost:8081}
    ports:
      - "8000:8000"
    networks: [appnet]
    profiles: ["with-backend"]

  # Use this when your backend runs on the HOST (not in Docker)
  frontend-only:
    build: .
    image: citizen-flow:latest
    ports:
      - "8081:80"
    environment:
      # On Docker Desktop (Win/macOS) this resolves to host; adjust on Linux
      BACKEND_URL: ${BACKEND_URL:-http://host.docker.internal:8080}
      VITE_API_URL: ""
      CITYASSIST_API_URL: ${CITYASSIST_API_URL:-http://host.docker.internal:8000}
    networks: [appnet]
    profiles: ["host-backend"]

  # Placeholder backend service (replace with your real image/build)
  backend:
    build:
      context: ../cityasist
    image: cityasist:latest
    environment:
      SPRING_DATASOURCE_URL: ${DB_URL:-jdbc:postgresql://db:5432/cityasist}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-postgres}
      APP_CORS_ALLOWED_ORIGINS: ${APP_CORS_ALLOWED_ORIGINS:-http://localhost:8081}
    depends_on:
      - db
    ports:
      - "8080:8080"
    networks: [appnet]
    profiles: ["with-backend"]

  db:
    image: postgres:16
    environment:
      POSTGRES_DB: cityasist
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - db_data:/var/lib/postgresql/data
    networks: [appnet]
    profiles: ["with-backend"]

volumes:
  db_data: {}
